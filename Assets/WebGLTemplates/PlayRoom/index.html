<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | PlaySpace</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <script src="Build/UnityLoader.js"></script>
    <script src="vendor/three.min.js"></script>
    <script src="vendor/BoxLineGeometry.js"></script>
    <script src="vendor/GLTFLoader.js"></script>
    <script src="vendor/WebVR.js"></script>
  </head>
  <body>
    <div class="webgl-content">
      <div id="gameContainer" style="width: 960px; height: 600px"></div>
      <div class="footer">
        <div class="webgl-logo"></div>
        <div class="fullscreen" onclick="gameInstance.SetFullscreen(1)"></div>
        <div class="title">PlaySpace</div>
      </div>
    </div>
    <script>
      var container;
      var camera, scene, renderer;
      var controller1, controller2;

      var room;

      var count = 0;
      var radius = 0.08;
      var normal = new THREE.Vector3();
      var relativeVelocity = new THREE.Vector3();

      var screenGeo;
      var screenMat;
      var screenMesh;
      var gameInstance;

      init();
      setupUnity();
      animate();

      function setupUnity() {
        function UnityProgress(gameInstance, progress) {
          if (!gameInstance.Module)
            return;

            if (!gameInstance.logo) {
              gameInstance.logo = document.createElement("div");
              gameInstance.logo.className = "logo " + gameInstance.Module.splashScreenStyle;
              gameInstance.container.appendChild(gameInstance.logo);
            }

            if (!gameInstance.progress) {    
              gameInstance.progress = document.createElement("div");
              gameInstance.progress.className = "progress " + gameInstance.Module.splashScreenStyle;
              gameInstance.progress.empty = document.createElement("div");
              gameInstance.progress.empty.className = "empty";
              gameInstance.progress.appendChild(gameInstance.progress.empty);
              gameInstance.progress.full = document.createElement("div");
              gameInstance.progress.full.className = "full";
              gameInstance.progress.appendChild(gameInstance.progress.full);
              gameInstance.container.appendChild(gameInstance.progress);
            }
            gameInstance.progress.full.style.width = (100 * progress) + "%";
            gameInstance.progress.empty.style.width = (100 * (1 - progress)) + "%";

            if (!screenMat.map) {
              // grab the unity canvas instance and pop it into three.
              screenMat.map = new THREE.CanvasTexture( gameInstance.Module.canvas );
            }

            if (gameInstance.container) {
              gameInstance.container.style.opacity = 0;
            }

            if (progress == 1) {
              gameInstance.logo.style.display = gameInstance.progress.style.display = "none";
            }
        }

        //

        UnityLoader.SystemInfo.mobile = false;
        gameInstance = UnityLoader.instantiate("gameContainer", "Build/Build.json", {
          Module: {
            // `preserveDrawingBuffer` is needed for content to be used as texture in THREE.
            webglContextAttributes: {
              preserveDrawingBuffer: true
            }
          },
          onProgress: UnityProgress
        });
      }

      function init() {

        container = document.createElement( 'div' );
        document.body.appendChild( container );

        var info = document.createElement( 'div' );
        info.style.position = 'absolute';
        info.style.top = '10px';
        info.style.width = '100%';
        info.style.textAlign = 'center';
        info.innerHTML = 'Playroom';
        container.appendChild( info );

        scene = new THREE.Scene();
        scene.background = new THREE.Color( 0x505050 );

        camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 0.1, 10 );

        var light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
        light.position.set( 1, 1, 1 );
        scene.add( light );

        // room model
				var loader = new THREE.GLTFLoader();
				loader.load( 'models/model.gltf', function ( gltf ) {
					gltf.scene.position.y = 2.05;
          gltf.scene.position.z = -2.2;
          gltf.scene.position.x = -0.026;
          gltf.scene.scale.set(2, 2, 2);
          gltf.scene.rotation.y = Math.PI / 2;
					scene.add( gltf.scene );
				}, undefined, function ( e ) {
					console.error( e );
        } );

        // unity canvas mesh to use as screen
        screenGeo = new THREE.PlaneGeometry( 1.5, 0.8, 1 );
        screenMat = new THREE.MeshBasicMaterial();
        screenMesh = new THREE.Mesh( screenGeo, screenMat );
        screenMesh.position.z = -1.9;
        screenMesh.position.y = 1.42;
        scene.add( screenMesh );

        //

        renderer = new THREE.WebGLRenderer( { antialias: true } );
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.vr.enabled = true;
        container.appendChild( renderer.domElement );

        //

        document.body.appendChild( WEBVR.createButton( renderer ) );

        // controllers

        function onSelectStart() {

          this.userData.isSelecting = true;

        }

        function onSelectEnd() {

          this.userData.isSelecting = false;

        }

        controller1 = renderer.vr.getController( 0 );
        controller1.addEventListener( 'selectstart', onSelectStart );
        controller1.addEventListener( 'selectend', onSelectEnd );
        scene.add( controller1 );

        controller2 = renderer.vr.getController( 1 );
        controller2.addEventListener( 'selectstart', onSelectStart );
        controller2.addEventListener( 'selectend', onSelectEnd );
        scene.add( controller2 );

        // helpers

        var geometry = new THREE.BufferGeometry();
        geometry.addAttribute( 'position', new THREE.Float32BufferAttribute( [ 0, 0, 0, 0, 0, - 1 ], 3 ) );
        geometry.addAttribute( 'color', new THREE.Float32BufferAttribute( [ 0.5, 0.5, 0.5, 0, 0, 0 ], 3 ) );

        var material = new THREE.LineBasicMaterial( { vertexColors: true, blending: THREE.AdditiveBlending } );

        controller1.add( new THREE.Line( geometry, material ) );
        controller2.add( new THREE.Line( geometry, material ) );

        //

        window.addEventListener( 'resize', onWindowResize, false );

      }

      function onWindowResize() {

        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );

      }

      function handleController( controller ) {
      }

      //

      function animate() {

        renderer.setAnimationLoop( render );

      }

      function render() {

        handleController( controller1 );
        handleController( controller2 );

        // Update Unity screen texture
        if (screenMat.map) {
          screenMat.map.needsUpdate = true;
        }

        renderer.render( scene, camera );

      }
    
    </script>
  </body>
</html>